{% load gestao_extras %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Concessionária</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .sidebar { position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; width: 250px; padding: 0; background-color: #212529; color: #fff; transition: all 0.3s; }
    .sidebar-header { padding: 20px; background-color: #1a1d20; border-bottom: 1px solid #343a40; }
    .sidebar .list-group-item { background-color: transparent; color: #ced4da; border: none; padding: 12px 20px; }
    .sidebar .list-group-item:hover { background-color: #343a40; color: #fff; }
    .sidebar .list-group-item.active { background-color: #0d6efd; color: #fff; font-weight: bold; }
    .sidebar i { width: 25px; text-align: center; margin-right: 10px; }
    .main-content { margin-left: 250px; display: flex; flex-direction: column; min-height: 100vh; }
    .top-header { background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,.08); padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .user-avatar { width: 40px; height: 40px; background-color: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #495057; font-size: 1.2rem; }
    .content-wrapper { padding: 0 30px 30px 30px; flex: 1; }
  </style>
</head>

<body>
{% if messages %}
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    {% for message in messages %}
      <div class="toast show align-items-center text-white bg-{{ message.tags }} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            {% if message.tags == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>{% endif %}
            {% if message.tags == 'danger' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>{% endif %}
            {{ message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% if user.is_authenticated %}
  <nav class="sidebar">
    <div class="sidebar-header">
      <h4 class="m-0 fw-bold"><i class="bi bi-car-front-fill text-primary"></i>Concessionária</h4>
    </div>
    <div class="list-group list-group-flush mt-3">
      <a href="{% url 'dashboard' %}" class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
        <i class="bi bi-speedometer2"></i> Dashboard
      </a>
      <a href="{% url 'registrar_venda' %}" class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'registrar_venda' %}active{% endif %}">
        <i class="bi bi-cart-plus"></i> Vendas
      </a>
      <a href="{% url 'veiculo_list' %}" class="list-group-item list-group-item-action {% if 'veiculo' in request.path %}active{% endif %}">
        <i class="bi bi-car-front"></i> Estoque
      </a>
      <a href="{% url 'cliente_list' %}" class="list-group-item list-group-item-action {% if 'cliente' in request.path %}active{% endif %}">
        <i class="bi bi-people"></i> Clientes
      </a>
      <a href="{% url 'venda_list' %}" class="list-group-item list-group-item-action {% if 'vendas/historico' in request.path %}active{% endif %}">
        <i class="bi bi-journal-text"></i> Histórico
      </a>
      {% if request.user|has_group:"Gerente" %}
        <div class="mt-4 px-3 text-muted small text-uppercase fw-bold">Gerência</div>
        <a href="{% url 'funcionario_list' %}" class="list-group-item list-group-item-action {% if 'funcionarios' in request.path %}active{% endif %}">
          <i class="bi bi-person-badge"></i> Equipe
        </a>
        <a href="{% url 'exportar_relatorio_pdf' %}" class="list-group-item list-group-item-action">
           <i class="bi bi-file-earmark-pdf"></i> Gerar relatório (PDF)
        </a>
      {% endif %}
    </div>
  </nav>
{% endif %}

<main class="{% if user.is_authenticated %}main-content{% endif %}">
  {% if user.is_authenticated %}
    <header class="top-header justify-content-end">
      <div class="dropdown">
        <div class="user-profile" data-bs-toggle="dropdown" aria-expanded="false">
          <div class="text-end d-none d-md-block">
            <div class="fw-bold text-dark">{{ user.first_name|default:user.username }}</div>
            {% if request.user|has_group:"Gerente" %}
              <span class="badge bg-danger" style="font-size: 0.7rem;">GERENTE</span>
            {% else %}
              <span class="badge bg-info text-dark" style="font-size: 0.7rem;">VENDEDOR</span>
            {% endif %}
          </div>
          <div class="user-avatar ms-2">
            <i class="bi bi-person-fill"></i>
          </div>
        </div>
        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
          <li><h6 class="dropdown-header">Minha Conta</h6></li>
          <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Perfil</a></li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item text-danger" href="{% url 'logout' %}">
              <i class="bi bi-box-arrow-right me-2"></i>Sair
            </a>
          </li>
        </ul>
      </div>
    </header>
  {% endif %}
  <div class="content-wrapper">
    {% block content %}{% endblock %}
  </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% block extra_js %}{% endblock %}
</body>
</html>