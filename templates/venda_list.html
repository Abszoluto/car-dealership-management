{% extends 'base.html' %}
{% load gestao_extras %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="bi bi-journal-text me-3"></i>Histórico de vendas</h1>
</div>
<div class="card mb-4 shadow-sm">
  <div class="card-body p-2">
    <form method="GET" class="row g-2">
      <div class="col-md-11">
        <input type="text" name="q" class="form-control border-0" placeholder="Realizar filtragem de vendas" value="{{ request.GET.q }}">
      </div>
      <div class="col-md-1">
        <button class="btn btn-outline-primary w-100" type="submit"><i class="bi bi-search"></i></button>
      </div>
    </form>
  </div>
</div>
<div class="card shadow">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Data</th>
            <th>Veículo</th>
            <th>Cliente</th>
            <th>Pagamento</th> {% if request.user|has_group:"Gerente" %}
                <th>Vendedor</th>
            {% endif %}
            <th>Valor Final</th>
            {% if request.user|has_group:"Gerente" %}<th>Ações</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for venda in vendas %}
            <tr>
              <td>
                <div class="fw-bold">{{ venda.data_venda|date:"d/m/Y" }}</div>
                <div class="small text-muted">{{ venda.data_venda|date:"H:i" }}</div>
              </td>
              <td>
                {{ venda.veiculo.modelo }}
                <br>
                <span class="badge bg-secondary">{{ venda.veiculo.marca }}</span>
              </td>
              <td>{{ venda.cliente.nome }}</td>
              <td>
                {% if venda.tipo_pagamento == 'vista' %}
                    <span class="badge bg-success">À Vista</span>
                {% elif venda.tipo_pagamento == 'financiado' %}
                    <span class="badge bg-warning text-dark">Financiado</span>
                {% else %}
                    <span class="badge bg-info text-dark">Cartão</span>
                {% endif %}
              </td>

              {% if request.user|has_group:"Gerente" %}
                <td>
                    <i class="bi bi-person-badge me-1 text-muted"></i>{{ venda.funcionario.username }}
                </td>
              {% endif %}
              <td class="text-success fw-bold">
                R$ {{ venda.preco_final|floatformat:2 }}
              </td>
              
              {% if request.user|has_group:"Gerente" %}
              <td>
                <a href="{% url 'venda_delete' venda.pk %}" class="btn btn-outline-danger btn-sm" title="Cancelar Venda">
                  <i class="bi bi-trash"></i>
                </a>
              </td>
              {% endif %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-center py-4">Nenhuma venda registrada encontrada.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if is_paginated %}
    <nav class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}">&laquo;</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}">&raquo;</a></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>
{% endblock %}